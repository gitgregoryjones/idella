var CSSTEXT_HARDCODEDCSSTEXT = "common-id:abc;common-alias:none;common-href:none;common-height: 1200px; common-width: 858.469px;common-color:white;common-z-index: auto; common-class:dropped-object;common-src:none; common-position: static;common-onhover:{}; common-loop:loop;common-autoplay:true;common-cursor: auto;animation-delay: 0s;slider-auto-slide:false;slider-duration:0px;slider-slide-animations:true;slider-buffer:0px;slider-how-many-items-each-slide:1;slider-direction:none;slider-container:none;animation-fun:none;  animation-direction: normal; animation-duration: 0s; animation-fill-mode: none; animation-iteration-count: 1; animation-name: none; animation-play-state: running; animation-timing-function: ease; background-attachment: scroll; background-blend-mode: normal; background-clip: border-box; background-color: rgb(244, 244, 244); background-image: none; background-origin: padding-box; background-position: 0% 0%; background-repeat: repeat; background-size: auto;  align:left; border:none; border-bottom-color: rgb(0, 0, 0); border-bottom-left-radius: 0px; border-bottom-right-radius: 0px; border-bottom-style: none; border-bottom-width: 0px; border-collapse: separate; border-image-outset: 0px; border-image-repeat: stretch; border-image-slice: 100%; border-image-source: none; border-image-width: 1; border-left-color: rgb(0, 0, 0); border-left-style: none; border-left-width: 0px; border-right-color: rgb(0, 0, 0); border-right-style: none; border-right-width: 0px; border-top-color: rgb(0, 0, 0); border-top-left-radius: 0px; border-top-right-radius: 0px; border-top-style: none; border-top-width: 0px; bottom: auto; box-shadow: none; box-sizing: content-box; break-after: auto; break-before: auto; break-inside: auto; caption-side: top; clear: none; clip: auto;  content: ; direction: ltr; display: block; empty-cells: show; float: none; font-family: Times; font-kerning: auto; font-size: 16px; font-stretch: normal; font-style: normal; font-variant: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: normal; font-weight: normal;  image-rendering: auto; isolation: auto; common-left: auto; letter-spacing: normal; line-height: normal; list-style-image: none; list-style-position: outside; list-style-type: disc; margin-bottom: 8px; margin-left: 8px; margin-right: 8px; margin-top: 8px; max-height: none; max-width: none; min-height: 0px; min-width: 0px; mix-blend-mode: normal; motion-offset: 0px; motion-path: none; motion-rotation: auto 0deg; object-fit: fill; object-position: 50% 50%; opacity: 1; orphans: 2; outline-color: rgb(0, 0, 0); outline-offset: 0px; outline-style: none; outline-width: 0px; overflow-wrap: normal; overflow-x: visible; overflow-y: visible; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; pointer-events: auto; resize: none; right: auto; speak: normal; table-layout: auto; tab-size: 8; text-align: start; text-align-last: auto; text-decoration: none; text-indent: 0px; text-rendering: auto; text-shadow: none; text-size-adjust: auto; text-overflow: clip; text-transform: none; common-top: auto; touch-action: auto; transition-cntrl-left:left; transition-cntrl-right:right;transition-duration: 0s;  transition-number-items: 1;  transition-delay: 0s;  transition-property: all; transition-timing-function: ease; unicode-bidi: normal; vertical-align: baseline; visibility: visible; white-space: normal; widows: 2; will-change: auto; word-break: normal; word-spacing: 0px; word-wrap: normal; zoom: 1; -webkit-appearance: none; backface-visibility: visible; -webkit-background-clip: border-box; -webkit-background-origin: padding-box; -webkit-border-horizontal-spacing: 0px; -webkit-border-image: none; -webkit-border-vertical-spacing: 0px; -webkit-box-align: stretch; -webkit-box-decoration-break: slice; -webkit-box-direction: normal; -webkit-box-flex: 0; -webkit-box-flex-group: 1; -webkit-box-lines: single; -webkit-box-ordinal-group: 1; -webkit-box-orient: horizontal; -webkit-box-pack: start; -webkit-box-reflect: none; -webkit-clip-path: none; column-count: auto; column-gap: normal; column-rule-color: rgb(0, 0, 0); column-rule-style: none; column-rule-width: 0px; column-span: none; column-width: auto; align-content: normal; align-items: stretch; align-self: stretch; flex-basis: auto; flex-grow: 0; flex-shrink: 1; flex-direction: row; flex-wrap: nowrap; justify-content: normal; -webkit-font-smoothing: auto; -webkit-highlight: none; -webkit-hyphenate-character: auto; -webkit-line-break: auto; -webkit-line-clamp: none; -webkit-locale: auto; -webkit-margin-before-collapse: collapse; -webkit-margin-after-collapse: collapse; -webkit-mask-box-image: none; -webkit-mask-box-image-outset: 0px; -webkit-mask-box-image-repeat: stretch; -webkit-mask-box-image-slice: 0 fill; -webkit-mask-box-image-source: none; -webkit-mask-box-image-width: auto; -webkit-mask-clip: border-box; -webkit-mask-composite: source-over; -webkit-mask-image: none; -webkit-mask-origin: border-box; -webkit-mask-position: 0% 0%; -webkit-mask-repeat: repeat; -webkit-mask-size: auto; order: 0; perspective: none; perspective-origin: 429.234px 600px; -webkit-print-color-adjust: economy; -webkit-rtl-ordering: logical; shape-outside: none; shape-image-threshold: 0; shape-margin: 0px; -webkit-tap-highlight-color: rgba(0, 0, 0, 0.4); -webkit-text-combine: none; -webkit-text-decorations-in-effect: none; -webkit-text-emphasis-color: rgb(0, 0, 0); -webkit-text-emphasis-position: over; -webkit-text-emphasis-style: none; -webkit-text-fill-color: rgb(0, 0, 0); -webkit-text-orientation: vertical-right; -webkit-text-security: none; -webkit-text-stroke-color: rgb(0, 0, 0); -webkit-text-stroke-width: 0px; transform: none; transform-origin: 429.234px 600px; transform-style: flat; -webkit-user-drag: auto; -webkit-user-modify: read-only; -webkit-user-select: text; -webkit-writing-mode: horizontal-tb; -webkit-app-region: no-drag; buffered-rendering: auto; clip-path: none; clip-rule: nonzero; mask: none; filter: none; flood-color: rgb(0, 0, 0); flood-opacity: 1; lighting-color: rgb(255, 255, 255); stop-color: rgb(0, 0, 0); stop-opacity: 1; color-interpolation: sRGB; color-interpolation-filters: linearRGB; color-rendering: auto; fill: rgb(0, 0, 0); fill-opacity: 1; fill-rule: nonzero; marker-end: none; marker-mid: none; marker-start: none; mask-type: luminance; shape-rendering: auto; stroke: none; stroke-dasharray: none; stroke-dashoffset: 0px; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 4; stroke-opacity: 1; stroke-width: 1px; alignment-baseline: auto; baseline-shift: 0px; dominant-baseline: auto; text-anchor: start; writing-mode: horizontal-tb; vector-effect: none; paint-order: fill stroke markers; d: none; cx: 0px; cy: 0px; x: 0px; y: 0px; r: 0px; rx: auto; ry: auto;";

var CSSTEXT_validStyles = {}; 

CSSTEXT_HARDCODEDCSSTEXT.split(";").forEach(function(style){
	var nd = style.split(":");
	if(nd){
	CSSTEXT_validStyles[nd[0].trim()] = nd[1]
	}
})

function writeClassToBreakPointCSSFile(div, myCSSLookupKey,theClassObj){

	var re = new RegExp(myCSSLookupKey+'\\s+\\{[^}]+\\}','img')

	var thescript = $("style.max-width-"+currentBreakPoint)
	console.log(myCSSLookupKey);
	console.log("The CSS RULE")
	console.log(theClassObj.cssRule);

	//temp remove last Brace.  Will add back after append
	thescript.html(thescript.html().substring(0,thescript.html().lastIndexOf("}") ) );

	styleCss = thescript.html();


	//test to see if style is not found, add it.  If found, replace it
	if(!thescript.html().match(re)){

		thescript.append(theClassObj.cssRule);
	}else {
		thescript.html(thescript.html().replace(re,theClassObj.cssRule))
	}

	thescript.html(thescript.html().trim() + "\n}")
		
	log.debug("Almost done " + website)

	theSiteObj.bp = BREAKPOINTS; 

	for(points in BREAKPOINTS){

		var cbp = BREAKPOINTS[points]

		log.debug("Retrieving site at breakpoint " + cbp);

		theSiteObj["@media-"+cbp] = $("style.max-width-"+cbp).html()
	}
}

function writeClassToMasterCSSFile(div, myCSSLookupKey,theClassObj){


	var re = new RegExp(myCSSLookupKey+'\\s+\\{[^}]+\\}','img')

	var thescript = "";

	log.debug("My Class should be persisted as")
	log.debug(theClassObj.cssRule)

	thescript = $("style.generated");

	

	styleCss = thescript.html();
	//test to see if style is not found, add it.  If found, replace it
	if(!thescript.html().match(re)){
		log.error("Appending RULE for " + myCSSLookupKey + " and rule " + theClassObj.cssRule)
		thescript.append(theClassObj.cssRule + "\n");
	}else {
		log.error("I found  RULE for " + myCSSLookupKey)
		thescript.html(thescript.html().replace(re,theClassObj.cssRule))
	}
	
}

function doWebkitHoverColor(div){
	const regex = /(^|[^-])color:([^;]+)(\s|;|$)/g;
	//const str = `-webkit-text-fill-color:red;background-color:blue;color:red;border-color:orange`;
	let m;

	var str = div.attr("onhover");

	if ((m = regex.exec(str)) !== null) {
	    // This is necessary to avoid infinite loops with zero-width matches
	   /* if (m.index === regex.lastIndex) {
	        regex.lastIndex++;
	    }*/
	    
	   var color=m[2];

	   str = "-webkit-text-fill-color:"+color+";" + str;

	   console.log("String is " + str)
	    div.attr("onhover",str);
	    // The result can be accessed through the `m`-variable.
	    /*m.forEach((match, groupIndex) => {
	        console.log(`Found match, group ${groupIndex}: ${match}`);
	    });*/
	 }
}


function CSS_TEXT_saveCss(div, theClassObj) {
//theClassObj = theClassObj ? CONVERT_STYLE_TO_CLASS_OBJECT($(div)) : theClassObj
	div = $(div);

	var myId = $(div).attr("id");

	var myCSSLookupKey = "\\." + $(div).attr("id")

	//if onhover, do color manipulation logic for webkit
	doWebkitHoverColor(div);

	if(isBreakPoint()){
		writeClassToBreakPointCSSFile(div, myCSSLookupKey,theClassObj)
		//Do Hover of attribute for object. Ugly but necessary. Without Else statement we would have left over ELEMENT:hover classes
		//in css when user clear the onhover attribute from #editSpace

		if(div.attr("onhover")){
			var outStr = "body.hover ." + div.attr("id") + ":hover {\n";

			outStr += "\t" + $(div).attr("onhover") + "\n";
			
			outStr += "}";
			theClassObj.cssRule = outStr;

			writeClassToBreakPointCSSFile(div,"body.hover "+ myCSSLookupKey+":hover",theClassObj);	
		} else {
			theClassObj.cssRule = "";
			writeClassToBreakPointCSSFile(div,"body.hover "+myCSSLookupKey + ":hover",theClassObj);		
		}

	} else {
		writeClassToMasterCSSFile(div,myCSSLookupKey,theClassObj);
		//Do Hover of attribute for object. Ugly but necessary. Without Else statement we would have left over ELEMENT:hover classes
		//in css when user clear the onhover attribute from #editSpace

		if(div.attr("onhover")){
			var outStr = "body.hover ." + div.attr("id") + ":hover {\n";

			outStr += "\t" + $(div).attr("onhover") + "\n";
			
			outStr += "}";
			theClassObj.cssRule = outStr;
			console.log("Anchor rule")
			console.log(theClassObj.cssRule)

			writeClassToMasterCSSFile(div,"body.hover "+myCSSLookupKey+":hover",theClassObj);	

				


		} else {
			theClassObj.cssRule = "";
			writeClassToMasterCSSFile(div,"body.hover " + myCSSLookupKey + ":hover",theClassObj);		
		}

		/*
		//Do overlay
			var outStr = "body.hover ." + div.attr("id") + ":hover [type=OVERLAY] {\n";

			outStr += "\t" + "visibility:visible;opacity:1" + "\n";
			
			outStr += "}";
			theClassObj.cssRule = outStr;
			console.log("OVERLAY rule")
			console.log(theClassObj.cssRule)

			writeClassToMasterCSSFile(div,"body.hover "+myCSSLookupKey+":hover [type=OVERLAY]",theClassObj);*/
	}

	console.log("Style before is " + div.attr("style"))

	div.removeAttr("style")
	console.log("Style is " + div.attr("style"))

	
}